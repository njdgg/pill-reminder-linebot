# 🚀 用藥提醒系統 - 部署配置指南

## 📋 概述
此指南說明其他開發者部署此用藥提醒系統時需要修改的配置內容。

---

## 🔧 必須修改的配置項目

### 1️⃣ **GCP 項目設定**

#### 修改文件：`GCP 部署.md`
```bash
# 將以下項目ID替換為您的GCP項目ID
# 當前設定：sunlit-hook-461906-r1
# 需要修改的地方：

# Docker Image 路徑
docker build -t us-central1-docker.pkg.dev/[您的項目ID]/njdg/pill_test:latest .
docker push us-central1-docker.pkg.dev/[您的項目ID]/njdg/pill_test:latest

# Cloud Run 部署
gcloud run deploy linebot0711 --image=us-central1-docker.pkg.dev/[您的項目ID]/njdg/pill_test:latest

# Cloud Scheduler URL（需要在部署後獲得實際URL）
--uri="https://[您的服務名稱]-[您的項目ID].us-central1.run.app/api/check-reminders"
```

### 2️⃣ **Python 代碼配置**

#### 修改文件：`config.py` (第41-44行)
```python
# 藥丸辨識 API 設定 - 替換為您的API服務URL
PILL_API_URLS = [
    "https://line-bot-[您的項目ID].us-central1.run.app",
    "https://line-bot2-[您的項目ID].us-central1.run.app", 
    "https://detect-api-self.wenalyzer.xyz/detect"  # 第三方API可保持不變
]
```

#### 修改文件：`app/routes/handlers/pill_handler.py` (第38-42行)
```python
# 替換API服務URL
apis = [
    {
        "name": "FastAPI Service",
        "url": "https://fastapi-[您的項目ID].us-central1.run.app"
    },
    {
        "name": "FastAPI V11 Service", 
        "url": "https://fastapiv11-[您的項目ID].us-central1.run.app/"
    }
]
```

### 3️⃣ **環境變數設定**

#### 創建您的 `.env` 文件（基於 `.env.example`）
```bash
# --- LINE Bot API 設定 ---
LINE_CHANNEL_ACCESS_TOKEN=您的_line_channel_access_token
LINE_CHANNEL_SECRET=您的_line_channel_secret
YOUR_BOT_ID=@您的_bot_id

# LINE Login 設定
LINE_LOGIN_CHANNEL_ID=您的_line_login_channel_id
LINE_LOGIN_CHANNEL_SECRET=您的_line_login_channel_secret

# --- LIFF 應用程式設定 ---
LIFF_CHANNEL_ID=您的_liff_channel_id
LIFF_ID_CAMERA=您的_camera_liff_id
LIFF_ID_EDIT=您的_edit_liff_id
LIFF_ID_PRESCRIPTION_REMINDER=您的_prescription_reminder_liff_id
LIFF_ID_MANUAL_REMINDER=您的_manual_reminder_liff_id
LIFF_ID_HEALTH_FORM=您的_health_form_liff_id

# --- Google Gemini API 設定 ---
GEMINI_API_KEY=您的_gemini_api_key

# --- MySQL 資料庫設定 ---
DB_HOST=您的_資料庫主機
DB_USER=您的_資料庫用戶名
DB_PASS=您的_資料庫密碼
DB_NAME=您的_資料庫名稱
DB_PORT=3306

# --- Cloud Scheduler 設定 ---
REMINDER_SECRET_TOKEN=您的-安全-隨機-token
```

### 4️⃣ **GCP 服務帳戶**

#### 替換文件：`cji25.json`
- 創建您自己的GCP服務帳戶
- 下載服務帳戶金鑰JSON文件
- 重命名為 `cji25.json` 或修改 `config.py` 中的路徑

---

## 🔍 部署前檢查清單

### ✅ **GCP 設定檢查**
- [ ] 已創建GCP項目
- [ ] 已啟用必要的API（Cloud Run, Artifact Registry, Cloud Scheduler）
- [ ] 已創建Artifact Registry repository
- [ ] 已設定Docker認證

### ✅ **LINE 設定檢查**
- [ ] 已創建LINE Bot Channel
- [ ] 已創建LINE Login Channel  
- [ ] 已創建所有必要的LIFF應用程式
- [ ] 已設定Webhook URL

### ✅ **資料庫設定檢查**
- [ ] 已創建MySQL資料庫
- [ ] 已執行資料庫初始化腳本
- [ ] 已測試資料庫連線

### ✅ **API 服務檢查**
- [ ] 已部署藥丸辨識API服務
- [ ] 已獲得Google Gemini API金鑰
- [ ] 已測試所有外部API連線

---

## 🚀 快速部署步驟

1. **克隆專案並修改配置**
   ```bash
   git clone [專案URL]
   cd [專案目錄]/0713
   ```

2. **修改配置文件**
   - 按照上述指南修改所有配置項目
   - 創建 `.env` 文件

3. **執行部署指令**
   ```bash
   # 按照 GCP 部署.md 中的步驟執行
   gcloud services enable run.googleapis.com artifactregistry.googleapis.com
   gcloud artifacts repositories create njdg --repository-format=docker --location=us-central1
   gcloud auth configure-docker us-central1-docker.pkg.dev
   
   # 建立並推送Docker Image
   docker build -t us-central1-docker.pkg.dev/[您的項目ID]/njdg/pill_test:latest .
   docker push us-central1-docker.pkg.dev/[您的項目ID]/njdg/pill_test:latest
   
   # 部署到Cloud Run
   gcloud run deploy linebot0711 --image=us-central1-docker.pkg.dev/[您的項目ID]/njdg/pill_test:latest --region=us-central1 --platform=managed --allow-unauthenticated --env-vars-file=env.yaml --min-instances=1 --memory=1Gi --timeout=300s
   
   # 設定Cloud Scheduler
   gcloud services enable cloudscheduler.googleapis.com
   gcloud app create --region=us-central1
   gcloud scheduler jobs create http reminder-check-job --location=us-central1 --schedule="* * * * *" --uri="https://[您的服務URL]/api/check-reminders" --http-method=POST --headers="Content-Type=application/json,Authorization=Bearer [您的token]" --description="每分鐘檢查並發送用藥提醒" --time-zone="Asia/Taipei"
   ```

---

## ⚠️ 重要注意事項

1. **安全性**：
   - 請使用強隨機字符串作為 `REMINDER_SECRET_TOKEN`
   - 不要將 `.env` 文件提交到版本控制系統
   - 定期輪換API金鑰和token

2. **成本控制**：
   - Cloud Scheduler 每分鐘執行會產生費用
   - 可根據需求調整執行頻率
   - 監控Cloud Run的使用量

3. **測試**：
   - 部署後請測試所有功能
   - 確認提醒系統正常運作
   - 檢查資料庫連線狀態

---

## 🆘 故障排除

如果遇到問題，請檢查：
1. 所有環境變數是否正確設定
2. GCP項目ID是否一致
3. 服務帳戶權限是否足夠
4. 網路連線是否正常
5. 查看Cloud Run和Cloud Scheduler的日誌

---

**最後更新**：2025年1月
**版本**：1.0.0