<!-- START OF FILE templates/edit_record.html (æœ€çµ‚ä¿®æ­£ç‰ˆ) -->
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>ä¿®æ”¹è—¥æ­·ç´€éŒ„</title>
<script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f0f2f5; margin: 0; padding: 15px; color: #333; }
  .container { max-width: 600px; margin: 0 auto; background-color: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: none; /* é è¨­éš±è— */ }
  .loading-container { text-align: center; padding-top: 50px; color: #666; }
  .header { background-color: #007bff; color: white; padding: 20px; border-radius: 8px 8px 0 0; text-align: center; }
  h2 { margin: 0; font-size: 1.2em; }
  .form-section { padding: 20px; border-bottom: 1px solid #eee; }
  .form-group { margin-bottom: 15px; }
  label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.9em; }
  input[type="text"], input[type="number"], input[type="date"], select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 1em; -webkit-appearance: none; appearance: none; background-color: white;}
  select { background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007AFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: right .7em top 50%; background-size: .65em auto;}
  .radio-group { display: flex; gap: 15px; margin-top: 5px; flex-wrap: wrap; }
  .radio-group label { font-weight: normal; display: flex; align-items: center; }
  .radio-group input { width: auto; margin-right: 5px; }
  textarea { resize: vertical; min-height: 80px; }
  .med-card { border: 1px solid #ddd; border-radius: 8px; margin-bottom: 20px; position: relative; overflow: hidden; transition: all 0.3s ease; }
  .med-card.expanded { box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
  
  .med-summary { 
    background-color: #f7f7f7; 
    padding: 15px; 
    display: flex; 
    justify-content: space-between; 
    align-items: center;
    cursor: default;
    border-bottom: 1px solid #eee;
  }
  
  .med-name { 
    font-weight: bold; 
    font-size: 1.1em; 
    color: #333;
    flex: 1;
  }
  
  .med-actions { 
    display: flex; 
    gap: 8px; 
  }
  
  .btn-edit, .btn-delete-simple { 
    padding: 8px 16px; 
    border: none; 
    border-radius: 4px; 
    cursor: pointer; 
    font-size: 1.1em;
    font-weight: bold;
    transition: all 0.2s;
    min-width: 60px;
  }
  
  .btn-edit { 
    background: #d0f0c0; 
    color: #057033; 
  }
  .btn-edit:hover { background: #c1e7b1; }
  
  .btn-delete-simple { 
    background: #FCD5CE; 
    color: #BA181B; 
  }
  .btn-delete-simple:hover { background: #F8AD9D; }
  
  .med-details { 
    padding: 20px; 
    background: white;
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease, padding 0.3s ease;
  }
  
  .med-details.expanded { 
    max-height: 800px; 
    padding: 20px;
  }
  
  .med-edit-actions {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #eee;
    display: flex;
    gap: 10px;
    justify-content: flex-end;
  }
  
  .btn-confirm, .btn-cancel {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.2s;
  }
  
  .btn-confirm {
    background: #28a745;
    color: white;
  }
  .btn-confirm:hover { background: #1e7e34; }
  
  .btn-cancel {
    background: #6c757d;
    color: white;
  }
  .btn-cancel:hover { background: #545b62; }
  .footer { padding: 20px; text-align: center; }
  button { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: bold; width: 100%; }
  .btn-primary { background-color: #28a745; color: white; }
  .btn-secondary { background-color: #6c757d; color: white; }
</style>
</head>
<body>

<div id="loading" class="loading-container">
    <p>æ­£åœ¨è¼‰å…¥è³‡æ–™...</p>
</div>

<div id="app" class="container">
    <div class="header"><h2 id="page-title">ç·¨è¼¯è—¥æ­·å…§å®¹</h2></div>
    <div class="form-section">
        <div class="form-group"><label for="clinic_name">è¨ºæ‰€åç¨±</label><input type="text" id="clinic_name"></div>
        <div class="form-group"><label for="visit_date">çœ‹è¨ºæ—¥æœŸ</label><input type="date" id="visit_date"></div>
        <div class="form-group"><label for="days_supply">çµ¦è—¥å¤©æ•¸</label><input type="number" id="days_supply" placeholder="ä¾‹å¦‚: 3"></div>
    </div>
    <div class="form-section">
        <h3>è—¥ç‰©åˆ—è¡¨</h3>
        <div id="medications-container"></div>
        <button id="add-med-btn" class="btn-secondary" style="margin-top:15px;">ï¼‹ æ–°å¢ä¸€ç­†è—¥ç‰©</button>
    </div>
    <div class="footer"><button id="save-btn" class="btn-primary">å„²å­˜ä¿®æ”¹ä¸¦é è¦½</button></div>
</div>

<script>
    const pageState = {
        liffId: '{{ liff_id_edit }}', // å°‡ç”± Flask å‚³å…¥
        idToken: null,
        originalData: {},
        medCounter: 0,
        frequencyOptions: {
            counts: [
                { value: 'QD', text: 'ä¸€æ—¥ä¸€æ¬¡' }, { value: 'BID', text: 'ä¸€æ—¥äºŒæ¬¡' },
                { value: 'TID', text: 'ä¸€æ—¥ä¸‰æ¬¡' }, { value: 'QID', text: 'ä¸€æ—¥å››æ¬¡' },
                { value: 'HS', text: 'ç¡å‰æœç”¨' }, { value: 'PRN', text: 'éœ€è¦æ™‚æœç”¨' }
            ],
            timings: [
                { value: 'AC', text: 'é£¯å‰' }, { value: 'PC', text: 'é£¯å¾Œ' },
                { value: 'NULL', text: 'çš†å¯/ä¸æŒ‡å®š' }
            ]
        }
    };

    const loadingView = document.getElementById('loading');
    const appView = document.getElementById('app');
    const medContainer = document.getElementById('medications-container');
    const addMedBtn = document.getElementById('add-med-btn');
    const saveBtn = document.getElementById('save-btn');
    const pageTitle = document.getElementById('page-title');
    const clinicNameInput = document.getElementById('clinic_name');
    const visitDateInput = document.getElementById('visit_date');
    const daysSupplyInput = document.getElementById('days_supply');

    function createMedCard(med = {}) {
        pageState.medCounter++;
        const cardId = `med-card-${pageState.medCounter}`;
        const card = document.createElement('div');
        card.className = 'med-card';
        card.id = cardId;
        
        const countOptionsHtml = pageState.frequencyOptions.counts.map(opt => 
            `<option value="${opt.value}" ${med.frequency_count_code === opt.value ? 'selected' : ''}>${opt.text}</option>`
        ).join('');

        const timingRadiosHtml = pageState.frequencyOptions.timings.map(opt => {
            const isChecked = med.frequency_timing_code === opt.value || (!med.frequency_timing_code && opt.value === 'NULL');
            return `<label><input type="radio" name="timing-${cardId}" value="${opt.value}" ${isChecked ? 'checked' : ''}>${opt.text}</label>`;
        }).join('');

        card.innerHTML = `
          <div class="med-summary">
            <span class="med-name">${med.drug_name_zh || med.drug_name_en || 'æœªå‘½åè—¥ç‰©'}</span>
            <div class="med-actions">
              <button class="btn-edit" data-target="${cardId}">ç·¨è¼¯</button>
              <button class="btn-delete-simple" data-target="${cardId}">åˆªé™¤</button>
            </div>
          </div>
          <div class="med-details" id="${cardId}-details">
            <input type="hidden" class="drug-name-en" value="${med.drug_name_en || ''}">
            <input type="hidden" class="matched-drug-id" value="${med.matched_drug_id || ''}">
            <input type="hidden" class="dosage-unit" value="${med.dosage_unit || ''}">
            <div class="form-group"><label>è—¥ç‰©ä¸­æ–‡åç¨±</label><input type="text" class="drug-name-zh" placeholder="è«‹è¼¸å…¥è—¥ç‰©ä¸­æ–‡åç¨±" value="${med.drug_name_zh || ''}"></div>
            <div class="form-group"><label>å–®æ¬¡åŠ‘é‡</label><input type="text" class="dose-quantity" placeholder="ä¾‹å¦‚: 1.00" value="${med.dose_quantity || ''}"></div>
            <div class="form-group">
                <label>æœç”¨æ¬¡æ•¸</label>
                <select class="frequency-count-code">${countOptionsHtml}</select>
            </div>
            <div class="form-group">
                <label>æœç”¨æ™‚æ©Ÿ</label>
                <div class="radio-group">${timingRadiosHtml}</div>
            </div>
            <div class="form-group"><label>ä¸»è¦ç”¨é€”</label><textarea class="main-use" placeholder="è«‹è¼¸å…¥ä¸»è¦ç”¨é€”">${med.main_use || ''}</textarea></div>
            <div class="form-group"><label>å¸¸è¦‹å‰¯ä½œç”¨</label><textarea class="side-effects" placeholder="è«‹è¼¸å…¥å¸¸è¦‹å‰¯ä½œç”¨">${med.side_effects || ''}</textarea></div>
            <div class="med-edit-actions">
              <button class="btn-cancel" data-target="${cardId}">å–æ¶ˆ</button>
              <button class="btn-confirm" data-target="${cardId}">ç¢ºèªä¿®æ”¹</button>
            </div>
          </div>`;
        medContainer.appendChild(card);
        
        // ç·¨è¼¯æŒ‰éˆ•äº‹ä»¶
        card.querySelector('.btn-edit').addEventListener('click', (e) => {
            const targetId = e.target.dataset.target;
            toggleCardExpansion(targetId);
        });
        
        // åˆªé™¤æŒ‰éˆ•äº‹ä»¶
        card.querySelector('.btn-delete-simple').addEventListener('click', (e) => {
            const targetId = e.target.dataset.target;
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹è—¥ç‰©å—ï¼Ÿ')) {
                document.getElementById(targetId).remove();
            }
        });
        
        // ç¢ºèªä¿®æ”¹æŒ‰éˆ•äº‹ä»¶
        card.querySelector('.btn-confirm').addEventListener('click', (e) => {
            const targetId = e.target.dataset.target;
            confirmMedicationEdit(targetId);
        });
        
        // å–æ¶ˆæŒ‰éˆ•äº‹ä»¶
        card.querySelector('.btn-cancel').addEventListener('click', (e) => {
            const targetId = e.target.dataset.target;
            cancelMedicationEdit(targetId);
        });
    }

    // æ‘ºç–Š/å±•é–‹å¡ç‰‡
    function toggleCardExpansion(cardId) {
        const card = document.getElementById(cardId);
        const details = document.getElementById(cardId + '-details');
        
        if (details.classList.contains('expanded')) {
            // æ”¶åˆ
            details.classList.remove('expanded');
            card.classList.remove('expanded');
        } else {
            // å±•é–‹
            details.classList.add('expanded');
            card.classList.add('expanded');
        }
    }

    // ç¢ºèªä¿®æ”¹
    function confirmMedicationEdit(cardId) {
        const card = document.getElementById(cardId);
        const nameInput = card.querySelector('.drug-name-zh');
        const nameDisplay = card.querySelector('.med-name');
        
        // æ›´æ–°é¡¯ç¤ºçš„è—¥ç‰©åç¨±
        const newName = nameInput.value.trim() || 'æœªå‘½åè—¥ç‰©';
        nameDisplay.textContent = newName;
        
        // æ”¶åˆå¡ç‰‡
        const details = document.getElementById(cardId + '-details');
        details.classList.remove('expanded');
        card.classList.remove('expanded');
        
        // å¯ä»¥åœ¨é€™è£¡æ·»åŠ ä¿å­˜æç¤º
        console.log('è—¥ç‰©è³‡è¨Šå·²æ›´æ–°:', newName);
    }

    // å–æ¶ˆç·¨è¼¯
    function cancelMedicationEdit(cardId) {
        const card = document.getElementById(cardId);
        const details = document.getElementById(cardId + '-details');
        
        // æ”¶åˆå¡ç‰‡
        details.classList.remove('expanded');
        card.classList.remove('expanded');
        
        // é€™è£¡å¯ä»¥æ·»åŠ æ¢å¾©åŸå§‹æ•¸æ“šçš„é‚è¼¯
        console.log('å–æ¶ˆç·¨è¼¯');
    }

    function renderPage(data) {
        pageState.originalData = data;
        const isFromSavedRecord = !!data.mm_id || (data.medications && data.medications.length > 0 && !data.task_id);

        if (isFromSavedRecord) {
            pageTitle.innerText = "ä¿®æ”¹è—¥æ­·ç´€éŒ„";
            saveBtn.innerText = "å„²å­˜ä¿®æ”¹";
        } else {
            pageTitle.innerText = "ç·¨è¼¯è—¥å–®è‰ç¨¿";
            saveBtn.innerText = "å„²å­˜ä¿®æ”¹ä¸¦é è¦½";
        }
        
        clinicNameInput.value = data.clinic_name || '';
        visitDateInput.value = data.visit_date || '';
        daysSupplyInput.value = data.days_supply || '';

        medContainer.innerHTML = '';
        pageState.medCounter = 0;
        if (data.medications && data.medications.length > 0) {
            data.medications.forEach(createMedCard);
        }

        loadingView.style.display = 'none';
        appView.style.display = 'block';
    }

    async function saveData() {
        saveBtn.disabled = true;
        saveBtn.innerText = "å„²å­˜ä¸­...";

        const medications = [];
        document.querySelectorAll('.med-card').forEach(card => {
            const timingRadio = card.querySelector(`input[name="timing-${card.id}"]:checked`);
            let timingCode = timingRadio ? timingRadio.value : null;
            if (timingCode === 'NULL') timingCode = null;

            medications.push({
                drug_name_zh: card.querySelector('.drug-name-zh').value.trim(),
                drug_name_en: card.querySelector('.drug-name-en').value.trim(),
                dose_quantity: card.querySelector('.dose-quantity').value.trim(),
                // ã€æ ¸å¿ƒä¿®æ­£ã€‘è®€å–éš±è—æ¬„ä½ä¸­çš„ dosage_unit
                dosage_unit: card.querySelector('.dosage-unit').value.trim(), 
                main_use: card.querySelector('.main-use').value.trim(),
                side_effects: card.querySelector('.side-effects').value.trim(),
                matched_drug_id: card.querySelector('.matched-drug-id').value.trim(),
                frequency_count_code: card.querySelector('.frequency-count-code').value,
                frequency_timing_code: timingCode
            });
        });
        
        const payload = { ...pageState.originalData };
        payload.clinic_name = clinicNameInput.value;
        payload.visit_date = visitDateInput.value;
        payload.days_supply = daysSupplyInput.value;
        payload.medications = medications;

        try {
            const response = await fetch('/api/draft/update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${pageState.idToken}`
                },
                body: JSON.stringify({ draftData: payload })
            });

            const result = await response.json();
            if (!response.ok) throw new Error(result.message || `ä¼ºæœå™¨éŒ¯èª¤ (${response.status})`);
            
            if (liff.isInClient()) {
                await liff.sendMessages([{ type: 'text', text: 'ğŸ“ é è¦½æ‰‹å‹•ä¿®æ”¹çµæœ' }]);
                liff.closeWindow();
            } else {
                alert("å„²å­˜æˆåŠŸï¼è«‹è¿”å› LINE æŸ¥çœ‹ã€‚");
            }
        } catch (err) {
            alert(`å„²å­˜å¤±æ•—ï¼š${err.message}`);
            saveBtn.disabled = false;
            saveBtn.innerText = pageState.originalData.mm_id ? "å„²å­˜ä¿®æ”¹" : "å„²å­˜ä¿®æ”¹ä¸¦é è¦½";
        }
    }

    async function main() {
        try {
            await liff.init({ liffId: pageState.liffId });
            if (!liff.isLoggedIn()) {
                // é¡¯ç¤ºç™»å…¥æç¤º
                loadingView.innerHTML = `
                    <div class="text-center">
                        <p style="color: #333; font-size: 1.1em; font-weight: bold; margin-bottom: 8px;">éœ€è¦ç™»å…¥ LINE å¸³è™Ÿ</p>
                        <p style="color: #666; font-size: 0.9em; margin-bottom: 16px;">æ­£åœ¨å°å‘ LINE ç™»å…¥é é¢...</p>
                    </div>
                `;
                liff.login({ redirectUri: location.href });
                return;
            }

            pageState.idToken = liff.getIDToken();
            if (!pageState.idToken) {
                throw new Error("ç„¡æ³•ç²å–æ‚¨çš„ LINE ID Tokenï¼Œè«‹é‡æ–°ç™»å…¥ã€‚");
            }

            const response = await fetch('/api/draft', {
                headers: { 'Authorization': `Bearer ${pageState.idToken}` }
            });
            
            if (!response.ok) {
                const errData = await response.json();
                console.error('è‰ç¨¿è¼‰å…¥å¤±æ•—:', errData);
                
                // å¦‚æœæ˜¯ 404 éŒ¯èª¤ï¼Œé¡¯ç¤ºå‹å–„çš„ç„¡è³‡æ–™é é¢
                if (response.status === 404) {
                    showNoDataPage(errData);
                    return;
                }
                
                // å…¶ä»–éŒ¯èª¤é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                let errorMessage = errData.message || `ç„¡æ³•å¾ä¼ºæœå™¨ç²å–è‰ç¨¿è³‡æ–™ (${response.status})`;
                if (errData.suggestion) {
                    errorMessage += '\n\nå»ºè­°ï¼š' + errData.suggestion;
                }
                
                throw new Error(errorMessage);
            }
            
            const data = await response.json();
            renderPage(data);

        } catch (err) {
            console.error("åˆå§‹åŒ–æˆ–ç²å–è³‡æ–™å¤±æ•—:", err);
            loadingView.innerHTML = `<p>éŒ¯èª¤ï¼š${err.message}<br>è«‹é—œé–‰æ­¤è¦–çª—ä¸¦é‡è©¦ã€‚</p>`;
        }
    }

    function showNoDataPage(errData) {
        loadingView.style.display = 'none';
        appView.innerHTML = `
            <div style="text-align: center; padding: 40px 20px; color: #666;">
                <div style="font-size: 64px; margin-bottom: 20px;">ğŸ“‹</div>
                <h2 style="color: #333; margin-bottom: 15px; font-size: 1.5em;">æ‰¾ä¸åˆ°å¯ç·¨è¼¯çš„è‰ç¨¿</h2>
                <p style="margin-bottom: 25px; line-height: 1.6; color: #666;">
                    ${errData.suggestion || 'è«‹å…ˆé€²è¡Œè—¥å–®æƒæåˆ†æï¼Œæˆ–å¾è—¥æ­·è¨˜éŒ„ä¸­é¸æ“‡è¦ä¿®æ”¹çš„é …ç›®ã€‚'}
                </p>
                <div style="margin-bottom: 30px; padding: 20px; background-color: #f8f9fa; border-radius: 8px; text-align: left;">
                    <h4 style="color: #495057; margin-bottom: 15px;">ğŸ“ å¦‚ä½•å»ºç«‹è‰ç¨¿ï¼š</h4>
                    <div style="margin-bottom: 15px;">
                        <strong>æ–¹æ¡ˆ Aï¼šæ–°è—¥å–®ç·¨è¼¯</strong>
                        <ol style="margin: 8px 0 0 20px; color: #6c757d;">
                            <li>é»æ“Šã€Œæƒææ–°è—¥å–®ã€</li>
                            <li>é¸æ“‡æˆå“¡ä¸¦ä¸Šå‚³ç…§ç‰‡</li>
                            <li>AI åˆ†æå®Œæˆå¾Œé»æ“Šã€Œâœï¸ æˆ‘ä¾†æ‰‹å‹•ç·¨è¼¯ã€</li>
                        </ol>
                    </div>
                    <div>
                        <strong>æ–¹æ¡ˆ Bï¼šæ­·å²è¨˜éŒ„ç·¨è¼¯</strong>
                        <ol style="margin: 8px 0 0 20px; color: #6c757d;">
                            <li>é»æ“Šã€ŒæŸ¥è©¢å€‹äººè—¥æ­·ã€</li>
                            <li>é¸æ“‡æˆå“¡å’Œè¨˜éŒ„</li>
                            <li>é»æ“Šã€Œâœï¸ æˆ‘è¦ä¿®æ”¹ã€</li>
                        </ol>
                    </div>
                </div>
                <button onclick="goBackToLine()" style="
                    background: #06C755; 
                    color: white; 
                    border: none; 
                    padding: 15px 30px; 
                    border-radius: 8px; 
                    font-size: 16px;
                    cursor: pointer;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                ">è¿”å› LINE</button>
            </div>
        `;
        appView.style.display = 'block';
    }

    function goBackToLine() {
        if (liff.isInClient()) {
            liff.closeWindow();
        } else {
            window.close();
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        addMedBtn.addEventListener('click', () => createMedCard());
        saveBtn.addEventListener('click', saveData);
        main();
    });
</script>
</body>
</html>
<!-- END OF FILE templates/edit_record.html (æœ€çµ‚ä¿®æ­£ç‰ˆ) -->