<!-- --- START OF FILE: app/templates/camera.html (å·²ä¿®æ”¹) --- -->

<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>å¾ç›¸ç°¿ä¸Šå‚³è—¥å–®</title>
<script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
  html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #f0f2f5; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
  .container { width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; box-sizing: border-box; padding: 20px; }
  .content { width: 90%; max-width: 480px; text-align: center; }
  .header { color: #333; font-size: 1.5em; font-weight: bold; margin-bottom: 15px; }
  .description { font-size: 1em; color: #666; margin-bottom: 30px; }
  button { display: block; width: 100%; padding: 15px; margin-bottom: 15px; border-radius: 12px; border: none; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: background-color 0.2s, opacity 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  button:disabled { opacity: 0.6; cursor: not-allowed; }
  .btn-single-album { background-color: #007bff; color: white; }
  .btn-multi-album { background-color: #28a745; color: white; }
  .status-message { margin-top: 20px; font-size: 1em; padding: 10px; border-radius: 8px; text-align: center; display: none; /* é è¨­éš±è— */ }
  .status-message.info { background-color: #e0e0e0; color: #333; }
  .status-message.error { background-color: #f8d7da; color: #721c24; }
</style>
</head>
<body>

<div class="container">
  <div class="content">
    <div class="header">ä¸Šå‚³è—¥å–®</div>
    <p class="description">è«‹é¸æ“‡æ‚¨å¸Œæœ›çš„æ–¹å¼ä¾†ä¸Šå‚³è—¥å–®ç…§ç‰‡</p>
    <button id="upload-single-btn" class="btn-single-album">ğŸ“‚ å¾ç›¸ç°¿ä¸Šå‚³å–®å¼µ</button>
    <button id="upload-multi-btn" class="btn-multi-album">ğŸ–¼ï¸ å¾ç›¸ç°¿ä¸Šå‚³å¤šå¼µ</button>
    <div id="status-message" class="status-message"></div>
  </div>
</div>

<!-- ä½¿ç”¨æ¨™æº–çš„æª”æ¡ˆé¸æ“‡å™¨ï¼Œå®Œå…¨ç¹é liff.media -->
<input type="file" id="single-file-input" accept="image/jpeg,image/png" style="display: none;">
<input type="file" id="multi-file-input" accept="image/jpeg,image/png" multiple style="display: none;">

<script>
document.addEventListener('DOMContentLoaded', () => {
    // DOM Elements
    const uploadSingleBtn = document.getElementById('upload-single-btn');
    const uploadMultiBtn = document.getElementById('upload-multi-btn');
    const singleFileInput = document.getElementById('single-file-input');
    const multiFileInput = document.getElementById('multi-file-input');
    const statusMessageDiv = document.getElementById('status-message');

    let lineUserId = null;
    let taskId = null;
    
    // --- [æ ¸å¿ƒä¿®æ”¹] ---
    // å°‡ç¡¬ç·¨ç¢¼çš„å­—ä¸²æ›¿æ›ç‚ºç”±å¾Œç«¯ Flask render_template å‚³å…¥çš„æ¨¡æ¿è®Šæ•¸
    // | safe éæ¿¾å™¨ç¢ºä¿å¼•è™Ÿä¸æœƒè¢« HTML è½‰ç¾©
    const LIFF_ID = '{{ liff_id_camera }}'; 

    function showStatus(message, type = 'info') {
        statusMessageDiv.textContent = message;
        statusMessageDiv.className = `status-message ${type}`;
        statusMessageDiv.style.display = 'block';
    }

    function setButtonsDisabled(disabled) {
        uploadSingleBtn.disabled = disabled;
        uploadMultiBtn.disabled = disabled;
    }

    async function uploadFiles(files) {
        if (!files || files.length === 0) return;
        if (!lineUserId || !taskId) {
            showStatus("é é¢åˆå§‹åŒ–æœªå®Œæˆæˆ–ç¼ºå°‘ä»»å‹™IDï¼Œç„¡æ³•ä¸Šå‚³ã€‚", 'error');
            return;
        }
        
        setButtonsDisabled(true);
        showStatus("æ­£åœ¨ä¸Šå‚³ç…§ç‰‡...");

        const formData = new FormData();
        formData.append('lineUserId', lineUserId);
        formData.append('taskId', taskId);
        
        if (files.length > 10) {
            showStatus("ä¸€æ¬¡æœ€å¤šåªèƒ½ä¸Šå‚³10å¼µç…§ç‰‡ã€‚", 'error');
            setButtonsDisabled(false);
            return;
        }

        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            formData.append('photos', file, `photo_${Date.now()}_${i}.jpg`);
        }

        try {
            // API è·¯ç”±å·²åœ¨ liff_views.py ä¸­å®šç¾©
            const response = await fetch('/api/photo/upload_multiple_prescriptions', { method: 'POST', body: formData });
            
            const result = await response.json();
            if (!response.ok) throw new Error(result.message || `ä¼ºæœå™¨éŒ¯èª¤ (${response.status})`);
            if (result.status !== "success") throw new Error(result.message || 'å¾Œç«¯å›å‚³æœªçŸ¥éŒ¯èª¤ã€‚');
            
            if (liff.isInClient()) {
                // å¦‚æœå¾Œç«¯æŒ‡ç¤ºè¦ç™¼é€è¨Šæ¯ä¸¦é—œé–‰è¦–çª—
                if (result.shouldSendMessage) {
                    await liff.sendMessages([{ type: 'text', text: result.message }]);
                }
                if (result.shouldClose) {
                    liff.closeWindow();
                }
            } else {
                showStatus("ä¸Šå‚³æˆåŠŸï¼è«‹è¿”å› LINE æŸ¥çœ‹ã€‚", 'info');
            }
        } catch (error) {
            showStatus(`ä¸Šå‚³å¤±æ•—ï¼š${error.message}`, 'error');
            setButtonsDisabled(false);
        }
    }

    async function main() {
        showStatus("æ­£åœ¨åˆå§‹åŒ–...");
        setButtonsDisabled(true);
        try {
            if (!LIFF_ID) {
                throw new Error("LIFF ID æœªè¨­å®šï¼Œè«‹æª¢æŸ¥å¾Œç«¯è¨­å®šã€‚");
            }
            
            await liff.init({ liffId: LIFF_ID });
            
            if (!liff.isLoggedIn()) {
                // é¡¯ç¤ºç™»å…¥æç¤º
                document.getElementById('loading').innerHTML = `
                    <div style="text-align: center; padding: 40px 20px;">
                        <p style="color: #333; font-size: 1.1em; font-weight: bold; margin-bottom: 8px;">éœ€è¦ç™»å…¥ LINE å¸³è™Ÿ</p>
                        <p style="color: #666; font-size: 0.9em; margin-bottom: 16px;">æ­£åœ¨å°å‘ LINE ç™»å…¥é é¢...</p>
                    </div>
                `;
                liff.login({ redirectUri: location.href });
                return;
            }
            
            const profile = await liff.getDecodedIDToken();
            lineUserId = profile.sub;
            if (!lineUserId) {
                throw new Error("ç„¡æ³•ç²å–æ‚¨çš„ LINE User IDã€‚");
            }

            const urlParams = new URLSearchParams(window.location.search);
            taskId = urlParams.get('taskId');
            
            if (!taskId) {
                // å¦‚æœ URL ä¸­æ²’æœ‰ taskIdï¼Œå˜—è©¦å¾ LIFF çš„ context ä¸­ç²å–
                const context = liff.getContext();
                if (context && context.queryStringParams && context.queryStringParams.taskId) {
                    taskId = context.queryStringParams.taskId;
                } else {
                    throw new Error("URL ä¸­ç¼ºå°‘ä»»å‹™ID (taskId)ï¼Œè«‹é—œé–‰è¦–çª—ä¸¦å¾LINEä¸­é‡æ–°æ“ä½œã€‚");
                }
            }
            
            showStatus("åˆå§‹åŒ–å®Œæˆï¼Œè«‹é¸æ“‡æª”æ¡ˆã€‚", "info");
            setButtonsDisabled(false);

        } catch (err) {
            if (err.message && err.message.includes("NotLoggedIn")) return;
            showStatus(`åˆå§‹åŒ–å¤±æ•—: ${err.message}`, 'error');
            setButtonsDisabled(true);
        }
    }

    // äº‹ä»¶ç¶å®š
    uploadSingleBtn.addEventListener('click', () => singleFileInput.click());
    uploadMultiBtn.addEventListener('click', () => multiFileInput.click());

    singleFileInput.addEventListener('change', (e) => {
        uploadFiles(e.target.files);
        e.target.value = null; 
    });
    multiFileInput.addEventListener('change', (e) => {
        uploadFiles(e.target.files);
        e.target.value = null; 
    });

    main();
});
</script>
</body>
</html>
<!-- --- END OF FILE: app/templates/camera.html --- -->